<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>MGL Manpower Optimization Dashboard</title>

<!-- SheetJS for Excel Parsing -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>

body {
  font-family: Inter, Segoe UI, Arial;
  margin: 0;
  background: #f3f5fa;
}

.app-header {
  background: #1f3fb3;
  color: white;
  padding: 18px 26px;
  font-size: 22px;
  font-weight: 600;
}

.container { padding: 18px 26px; }

.card {
  background: white;
  border-radius: 14px;
  padding: 16px 18px;
  margin-bottom: 14px;
  box-shadow: 0 10px 18px rgba(0,0,0,.05);
  border: 1px solid #e5e7ff;
}

.card h3 { margin: 0 0 6px 0; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
}

th {
  background: #eef1ff;
  padding: 8px;
  border: 1px solid #dae0ff;
}

td {
  border: 1px solid #e4e7f0;
  padding: 6px;
}

input {
  padding: 6px;
  border-radius: 8px;
  border: 1px solid #cfd6ec;
}

button {
  padding: 10px 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 600;
}

.upload-btn { background:#374df5; color:white; }
.run-btn { background:#1f3fb3; color:white; }
.refresh-btn { background:#777; color:white; }

.success { color:#15803d; }
.warning { color:#b45309; }

.results-card { overflow-x:auto; }

</style>
</head>

<body>

<div class="app-header">
  MGL Manpower Optimization Dashboard
</div>

<div class="container">


<!-- Upload Task Sheets -->

<div class="card">
  <h3>Upload Employee Task Sheets (Excel)</h3>

  <input type="file" id="excelUpload" multiple accept=".xlsx,.xls">
  <button class="upload-btn" onclick="uploadSheets()">Upload & Process</button>

  <div id="uploadStatus" style="margin-top:8px;"></div>
</div>


<!-- Workload Summary -->

<div class="card">
  <h3>Function-wise Workload Summary (Auto Computed)</h3>

  <table id="workloadSummary">
    <thead>
      <tr>
        <th>Function</th>
        <th>Employees</th>
        <th>Total Min Hrs</th>
        <th>Total Max Hrs</th>
        <th>Total Avg Hrs</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<!-- Headcount Input -->

<div class="card">
  <h3>Headcount (Existing Manpower)</h3>

  <table id="hcTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>


<!-- Run Model -->

<div class="card">
  <button class="run-btn" onclick="runOptimization()">Run Optimization</button>
  <button class="refresh-btn" onclick="loadWorkload()">Refresh Data</button>

  <div id="status" style="margin-top:8px;"></div>
</div>


<!-- Results -->

<div class="card results-card">
  <h3>Optimization Results</h3>
  <div id="results"></div>
</div>


</div>


<script>

/* --------------------------
   Backend Base URL
   (Change to your Railway URL)
--------------------------- */

const BASE_URL = "https://mglbackend-production.up.railway.app";



/* --------------------------
   1) Upload & Process Excel
--------------------------- */

async function uploadSheets() {

  const files = document.getElementById("excelUpload").files;
  if (!files.length) return alert("Select at least one Excel file");

  document.getElementById("uploadStatus").innerHTML =
    "Processing uploaded sheets…";

  for (let file of files) {

    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header:1 });

    let employee = {
      name:"",
      code:"",
      func:"",
      min:0,
      max:0,
      avg:0
    };

    /* ---- Extract Function / Employee details ---- */

    rows.forEach(r => {
      if (!r[0]) return;

      const text = r[0].toString().toLowerCase();

      if (text.includes("function"))
        employee.func = r[1];

      if (text.includes("employee name"))
        employee.name = r[1];

      if (text.includes("employee code"))
        employee.code = r[1];
    });


    /* ---- Detect workload values anywhere in sheet ---- */

    let nums = [];

    rows.forEach(r=>{
      r.forEach(c=>{
        const v = parseFloat(c);
        if (!isNaN(v) && v>0 && v<24) nums.push(v);
      });
    });

    if (nums.length === 1) {
      employee.min = nums[0];
      employee.max = nums[0];
    } else {
      employee.min = nums[nums.length-2] || 0;
      employee.max = nums[nums.length-1] || employee.min;
    }

    employee.avg = (employee.min + employee.max) / 2;


    /* ---- Send parsed sheet to backend ---- */

    await fetch(BASE_URL + "/upload_sheet", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(employee)
    });
  }

  document.getElementById("uploadStatus").innerHTML =
    "<span class='success'>Sheets processed successfully ✔</span>";

  loadWorkload();
}



/* --------------------------
   2) Load Workload Summary
--------------------------- */

async function loadWorkload() {

  const res = await fetch(BASE_URL + "/workload");
  const data = await res.json();

  const tbody = document.querySelector("#workloadSummary tbody");
  tbody.innerHTML = "";

  Object.keys(data.functions).forEach(f => {

    const row = data.functions[f];

    tbody.innerHTML += `
      <tr>
        <td>${f}</td>
        <td>${row.employees}</td>
        <td>${row.min.toFixed(2)}</td>
        <td>${row.max.toFixed(2)}</td>
        <td>${row.avg.toFixed(2)}</td>
      </tr>`;
  });

  buildHeadcountTable(Object.keys(data.functions));
}



/* --------------------------
   3) Headcount Table
--------------------------- */

const ROLES = ["Manager","AsstManager","Officer","Executive"];

function buildHeadcountTable(functions){

  const head = `<tr>
    <th>Function</th>
    ${ROLES.map(r=>`<th>${r}</th>`).join("")}
  </tr>`;

  document.querySelector("#hcTable thead").innerHTML = head;

  const body = functions.map(f=>
    `<tr>
      <td>${f}</td>
      ${ROLES.map(()=>`<td><input value="0"></td>`).join("")}
    </tr>`
  ).join("");

  document.querySelector("#hcTable tbody").innerHTML = body;
}



/* --------------------------
   4) Run Optimization
--------------------------- */

async function runOptimization(){

  document.getElementById("status").innerHTML =
    "Running optimization…";

  // build headcount matrix
  const N_current = {};
  document.querySelectorAll("#hcTable tbody tr").forEach(r => {
    const func = r.children[0].innerText;
    ROLES.forEach((role,i)=>{
      N_current[`${func}|${role}`] =
        parseInt(r.children[i+1].children[0].value) || 0;
    });
  });

  const res = await fetch(BASE_URL + "/optimize", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ N_current })
  });

  const data = await res.json();

  document.getElementById("status").innerHTML =
    "<span class='success'>Optimization Complete ✔</span>";

  /* ---- Render Results ---- */

  let html = `<table>
    <tr>
      <th>Function</th>
      <th>Role</th>
      <th>Current</th>
      <th>Optimal</th>
      <th>Removed</th>
      <th>Capacity</th>
      <th>Shortage</th>
    </tr>`;

  data.rows.forEach(r=>{
    html += `
      <tr>
        <td>${r.Function}</td>
        <td>${r.Role}</td>
        <td>${r.Current}</td>
        <td>${r.Optimal}</td>
        <td>${r.Removed}</td>
        <td>${r.Capacity}</td>
        <td>${r.Shortage}</td>
      </tr>`;
  });

  html += "</table>";
  document.getElementById("results").innerHTML = html;
}

</script>

</body>
</html>
