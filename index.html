<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>MGL Manpower Optimization Dashboard</title>

<!-- Excel Parser -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>

body {
  font-family: Inter, Segoe UI, Arial;
  margin: 0;
  background: #f3f5fa;
}

.app-header {
  background: #1f3fb3;
  color: white;
  padding: 18px 26px;
  font-size: 22px;
  font-weight: 600;
}

.container { padding: 18px 26px; }

.card {
  background: white;
  border-radius: 14px;
  padding: 16px 18px;
  margin-bottom: 14px;
  box-shadow: 0 10px 18px rgba(0,0,0,.05);
  border: 1px solid #e5e7ff;
}

h3 { margin: 0 0 6px 0; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
}

th {
  background: #eef1ff;
  padding: 8px;
  border: 1px solid #dbe0ff;
}

td {
  border: 1px solid #e2e6f2;
  padding: 6px;
}

button {
  padding: 10px 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 600;
}

.upload-btn { background:#374df5; color:white; }
.run-btn { background:#1f3fb3; color:white; }
.refresh-btn { background:#6b7280; color:white; }

.success { color:#15803d; }
.warning { color:#b45309; }

.results-card { overflow-x:auto; }

.summary-box {
  margin-top:8px;
  padding:8px;
  background:#eef1ff;
  border-radius:10px;
}

</style>
</head>

<body>

<div class="app-header">
  MGL Manpower Optimization Dashboard
</div>

<div class="container">


<!-- Upload -->

<div class="card">
  <h3>Upload Employee Task Sheets</h3>

  <input type="file" id="excelUpload" multiple accept=".xlsx,.xls">
  <button class="upload-btn" onclick="processSheets()">Upload & Compute</button>

  <div id="uploadStatus" style="margin-top:6px;"></div>
</div>


<!-- Workload Summary -->

<div class="card">
  <h3>Function-wise Workload Summary</h3>

  <div class="summary-box" id="overallTotals"></div>

  <table id="workloadTable">
    <thead>
      <tr>
        <th>Function</th>
        <th>Employees</th>
        <th>Total Min Hrs</th>
        <th>Total Max Hrs</th>
        <th>Total Avg Hrs</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<!-- Headcount -->

<div class="card">
  <h3>Current Manpower (Auto Extracted from Excel)</h3>

  <table id="hcTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>


<!-- Run -->

<div class="card">
  <button class="run-btn" onclick="runOptimization()">Run Optimization</button>

  <div id="status" style="margin-top:8px;"></div>
</div>


<!-- Results -->

<div class="card results-card">
  <h3>Optimization Results</h3>
  <div id="results"></div>
</div>


</div>


<script>

/* Backend API */
const BASE_URL = "https://mglbackend-production.up.railway.app";


/* Role Normalization */
const ROLE_MAP = {
  "manager":"Manager",
  "sr manager":"Manager",
  "senior manager":"Manager",

  "assistant manager":"AsstManager",
  "asst manager":"AsstManager",
  "am":"AsstManager",

  "officer":"Officer",

  "executive":"Executive",
  "jr executive":"Executive",
  "junior executive":"Executive"
};


/* Runtime Stores */

let FUNCTIONS = {};      // workload aggregation
let CURRENT_HC = {};     // current manpower
let FUNCTION_SET = new Set();


/* ---------------------------------------------------
   PROCESS EMPLOYEE EXCEL FILES
----------------------------------------------------*/

async function processSheets() {

  const files = document.getElementById("excelUpload").files;
  if (!files.length) return alert("Please upload at least one file");

  FUNCTIONS = {};
  CURRENT_HC = {};
  FUNCTION_SET = new Set();

  let TOTAL_MIN = 0, TOTAL_MAX = 0, TOTAL_AVG = 0;

  document.getElementById("uploadStatus").innerHTML =
    "Processing sheets…";


  for (let file of files) {

    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header:1 });

    let func = "";
    let role = "";
    let minH = 0, maxH = 0;

    /* --- Header Extraction (Function / Role) --- */

    rows.forEach(r=>{
      if(!r[0]) return;

      const t = r[0].toString().toLowerCase();

      if (t.includes("function"))
        func = (r[1] || "").toString().trim();

      if (t.includes("designation") ||
          t.includes("employee grade") ||
          t.includes("role"))
      {
        const raw = (r[1] || "").toString().toLowerCase();
        role = ROLE_MAP[raw] || "Executive";
      }
    });

    if (!func) func = "Unmapped Function";

    FUNCTION_SET.add(func);


    /* --- Workload Detection (Min / Max Hours) --- */

    let nums = [];

    rows.forEach(r=>{
      r.forEach(c=>{
        const v = parseFloat(c);
        if (!isNaN(v) && v>0 && v<24) nums.push(v);
      });
    });

    if (nums.length === 1) {
      minH = nums[0];
      maxH = nums[0];
    } else {
      minH = nums[nums.length-2] || 0;
      maxH = nums[nums.length-1] || minH;
    }

    const avgH = (minH + maxH) / 2;


    /* --- Aggregate Workload by Function --- */

    if (!(func in FUNCTIONS)) {
      FUNCTIONS[func] = {
        employees:0,
        min:0,
        max:0,
        avg:0
      };
    }

    FUNCTIONS[func].employees++;
    FUNCTIONS[func].min += minH;
    FUNCTIONS[func].max += maxH;
    FUNCTIONS[func].avg += avgH;

    TOTAL_MIN += minH;
    TOTAL_MAX += maxH;
    TOTAL_AVG += avgH;


    /* --- Auto Headcount Aggregation --- */

    const key = `${func}|${role}`;
    CURRENT_HC[key] = (CURRENT_HC[key] || 0) + 1;


    /* --- Send employee to backend for record (optional) --- */

    await fetch(BASE_URL + "/upload_sheet", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        name:"",
        code:"",
        func:func,
        min:minH,
        max:maxH,
        avg:avgH
      })
    });
  }


  /* -------- Display Overall Totals -------- */

  document.getElementById("overallTotals").innerHTML =
    `<b>Total Workload (All Employees)</b><br>
     Min = ${TOTAL_MIN.toFixed(2)} hrs/day &nbsp; |
     Max = ${TOTAL_MAX.toFixed(2)} hrs/day &nbsp; |
     Avg = ${TOTAL_AVG.toFixed(2)} hrs/day`;


  /* -------- Build Workload Table -------- */

  const tbody = document.querySelector("#workloadTable tbody");
  tbody.innerHTML = "";

  Object.keys(FUNCTIONS).forEach(f=>{
    const row = FUNCTIONS[f];

    tbody.innerHTML += `
      <tr>
        <td>${f}</td>
        <td>${row.employees}</td>
        <td>${row.min.toFixed(2)}</td>
        <td>${row.max.toFixed(2)}</td>
        <td>${row.avg.toFixed(2)}</td>
      </tr>`;
  });


  /* -------- Build Current Headcount Table -------- */

  buildHeadcountTable();

  document.getElementById("uploadStatus").innerHTML =
    `<span class="success">Files processed successfully ✔</span>`;
}



/* ---------------------------------------------------
   CURRENT HC TABLE (AUTO-FILLED)
----------------------------------------------------*/

const ROLES = ["Manager","AsstManager","Officer","Executive"];

function buildHeadcountTable() {

  const head =
    `<tr>
      <th>Function</th>
      ${ROLES.map(r=>`<th>${r}</th>`).join("")}
    </tr>`;

  document.querySelector("#hcTable thead").innerHTML = head;

  const body = Array.from(FUNCTION_SET).map(f=>{
    return `<tr>
      <td>${f}</td>
      ${ROLES.map(role=>{
        const key = `${f}|${role}`;
        const val = CURRENT_HC[key] || 0;
        return `<td>${val}</td>`;
      }).join("")}
    </tr>`;
  }).join("");

  document.querySelector("#hcTable tbody").innerHTML = body;
}



/* ---------------------------------------------------
   RUN OPTIMIZATION
----------------------------------------------------*/

async function runOptimization() {

  document.getElementById("status").innerHTML =
    "Running optimization…";

  const res = await fetch(BASE_URL + "/optimize", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      N_current: CURRENT_HC
    })
  });

  const data = await res.json();

  document.getElementById("status").innerHTML =
    `<span class="success">Optimization Completed ✔</span>`;

  renderResults(data.rows);
}



/* ---------------------------------------------------
   RENDER RESULTS TABLE
----------------------------------------------------*/

function renderResults(rows){

  let html = `<table>
    <tr>
      <th>Function</th>
      <th>Role</th>
      <th>Current</th>
      <th>Optimal</th>
      <th>Surplus / Removable</th>
      <th>Capacity</th>
      <th>Shortage</th>
    </tr>`;

  rows.forEach(r=>{
    html += `
      <tr>
        <td>${r.Function}</td>
        <td>${r.Role}</td>
        <td>${r.Current}</td>
        <td>${r.Optimal}</td>
        <td>${r.Removed}</td>
        <td>${r.Capacity}</td>
        <td>${r.Shortage}</td>
      </tr>`;
  });

  html += "</table>";

  document.getElementById("results").innerHTML = html;
}

</script>

</body>
</html>
