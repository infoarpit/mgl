<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>MGL Manpower Optimization Dashboard</title>

<!-- Excel Parser -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Inter, Segoe UI, Arial; margin:0; background:#f3f5fa; }
.header { background:#1f3fb3; color:white; padding:18px 24px; font-size:22px; font-weight:600; }
.container { padding:18px 24px; }
.card { background:white; border-radius:14px; padding:16px 18px; margin-bottom:14px;
        border:1px solid #e6ebff; box-shadow:0 10px 18px rgba(0,0,0,.04); }
h3 { margin:6px 0 10px 0; }
table { width:100%; border-collapse:collapse; margin-top:8px; }
th { background:#eef1ff; padding:8px; border:1px solid #dbe0f5; }
td { border:1px solid #e2e6f2; padding:6px; }
input { border-radius:10px; border:1px solid #cfd6ec; padding:6px 8px; width:95%; }
.button { padding:10px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:600; }
.run { background:#1f3fb3; color:white; }
.refresh { background:#6b7280; color:white; }
.uploadBox { border:2px dashed #3564ff; padding:28px; text-align:center; border-radius:14px;
             background:#fafbff; cursor:pointer; }
.success { color:#15803d; font-weight:600; }
.warn { color:#b45309; font-weight:600; }
</style>
</head>

<body>

<div class="header">MGL Manpower Optimization Dashboard</div>
<div class="container">

<!-- Upload Section -->
<div class="card">
  <h3>Upload Employee Task Sheets</h3>

  <label class="uploadBox">
    <input id="fileInput" type="file" multiple accept=".xlsx,.xls" style="display:none">
    üìÅ Click to Upload Employee Excel Files
    <br>or drag & drop files here
  </label>

  <div id="uploadStatus" style="margin-top:8px"></div>
</div>


<!-- Workload Summary -->
<div class="card">
  <h3>Function Workload Summary</h3>

  <table id="workTable">
    <thead>
      <tr>
        <th>Function</th>
        <th>Employees</th>
        <th>Total Min (hrs/day)</th>
        <th>Total Max (hrs/day)</th>
        <th>Total Avg (hrs/day)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<!-- Headcount Table -->
<div class="card">
  <h3>Current Headcount</h3>

  <table id="hcTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>


<!-- Run Buttons -->
<div class="card">
  <button class="button refresh" onclick="loadWorkload()">Refresh Workload</button>
  <button class="button run" onclick="runOptimization()">Run Optimization</button>
  <div id="status" style="margin-top:8px"></div>
</div>


<!-- Results -->
<div class="card">
  <h3>Optimization Results</h3>
  <div id="results"></div>
</div>

</div>


<script>

// --------------------------------------
// CONFIGURE BACKEND URL
// --------------------------------------
const BACKEND = "https://mglbackend-production.up.railway.app";


// --------------------------------------
// FILE UPLOAD HANDLER
// --------------------------------------
const fileInput = document.getElementById("fileInput");
fileInput.addEventListener("change", handleFiles);

async function handleFiles(evt) {

  const files = evt.target.files;
  document.getElementById("uploadStatus").innerHTML =
    "Processing files‚Ä¶ please wait";

  for (let file of files) {

    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type:"array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet, { header:1 });

    // ---- Extract header fields ----
    let func="", name="", code="";
    data.forEach(r=>{
      if(!r || r.length<2) return;
      const k = String(r[0]).toLowerCase();

      if(k.includes("function")) func = r[1];
      if(k.includes("employee name")) name = r[1];
      if(k.includes("employee code")) code = r[1];
    });

    if(!func){
      alert("Could not detect Function in: " + file.name);
      continue;
    }

    // ---- Detect workload mins & max ----
    let nums=[];
    data.flat().forEach(v=>{
      if(typeof v==="number" && v>0 && v<24) nums.push(v);
    });

    if(nums.length===0){
      alert("No valid workload values in: " + file.name);
      continue;
    }

    const min = nums.at(-2) ?? nums.at(-1);
    const max = nums.at(-1);
    const avg = (min+max)/2;

    // ---- Send to backend ----
    await fetch(BACKEND + "/upload_sheet",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ name, code, func, min, max, avg })
    });
  }

  document.getElementById("uploadStatus").innerHTML =
    "<span class='success'>Upload complete ‚úî</span>";

  loadWorkload();
}



// --------------------------------------
// LOAD WORKLOAD SUMMARY
// --------------------------------------
async function loadWorkload(){

  const res = await fetch(BACKEND + "/workload");
  const data = await res.json();

  const tbody = document.querySelector("#workTable tbody");
  tbody.innerHTML="";

  Object.entries(data.functions).forEach(([f,v])=>{
    tbody.innerHTML += `
      <tr>
        <td>${f}</td>
        <td>${v.employees}</td>
        <td>${v.min.toFixed(2)}</td>
        <td>${v.max.toFixed(2)}</td>
        <td>${v.avg.toFixed(2)}</td>
      </tr>`;
  });

  buildHeadcountTable(Object.keys(data.functions));
}



// --------------------------------------
// BUILD HEADCOUNT GRID
// --------------------------------------
function buildHeadcountTable(F){

  const R = ["Manager","AsstManager","Officer","Executive"];

  document.querySelector("#hcTable thead").innerHTML =
    `<tr><th>Function</th>${R.map(r=>`<th>${r}</th>`).join("")}</tr>`;

  const body = F.map(f=>`
    <tr>
      <td>${f}</td>
      ${R.map(()=>`<td><input value="0"></td>`).join("")}
    </tr>`).join("");

  document.querySelector("#hcTable tbody").innerHTML = body;
}



// --------------------------------------
// RUN OPTIMIZATION
// --------------------------------------
async function runOptimization(){

  document.getElementById("status").innerHTML = "Running‚Ä¶";

  const N_current={};
  const R=["Manager","AsstManager","Officer","Executive"];

  document.querySelectorAll("#hcTable tbody tr").forEach(row=>{
    const f=row.children[0].innerText;
    R.forEach((r,i)=>{
      N_current[`${f}|${r}`] =
        parseInt(row.children[i+1].children[0].value || 0);
    });
  });

  const res = await fetch(BACKEND + "/optimize",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ N_current })
  });

  const data = await res.json();

  document.getElementById("status").innerHTML =
    "<span class='success'>Optimization complete ‚úî</span>";

  let html = `<table>
  <tr>
    <th>Function</th><th>Role</th>
    <th>Current</th><th>Optimal</th><th>Removed</th>
    <th>Capacity</th><th>Shortage</th>
  </tr>`;

  data.rows.forEach(r=>{
    html += `<tr>
      <td>${r.Function}</td>
      <td>${r.Role}</td>
      <td>${r.Current}</td>
      <td>${r.Optimal}</td>
      <td>${r.Removed}</td>
      <td>${r.Capacity}</td>
      <td>${r.Shortage}</td>
    </tr>`;
  });

  html += "</table>";
  document.getElementById("results").innerHTML = html;
}

loadWorkload();

</script>
</body>
</html>
