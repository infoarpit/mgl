<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>MGL Manpower Optimization Dashboard</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>

<style>

body{
  font-family: Inter, Arial;
  margin:0;
  background:#f4f6fb;
}

.header{
  background:#1f3fb3;
  color:white;
  padding:16px 24px;
  font-size:22px;
  font-weight:600;
}

.container{
  padding:18px 26px;
}

.card{
  background:white;
  border-radius:14px;
  padding:16px 18px;
  margin-bottom:14px;
  box-shadow: 0 8px 16px rgba(0,0,0,.05);
  border:1px solid #e4e8ff;
}

.card h3{
  margin:0 0 8px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:6px;
}

th{
  background:#eef1ff;
  border:1px solid #dde2f7;
  padding:8px;
  font-weight:600;
}

td{
  border:1px solid #e5e8f3;
  padding:6px;
}

.tag{
  font-weight:600;
}

.green{
  color:#15803d;
}

.btn{
  padding:10px 16px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-weight:600;
}

.primary{
  background:#1f3fb3;
  color:white;
}

</style>
</head>

<body>

<div class="header">
  MGL Manpower Optimization Dashboard
</div>

<div class="container">


<!-- ===================== UPLOAD SECTION ===================== -->

<div class="card">
  <h3>Upload Employee Task Sheets</h3>

  <input type="file" multiple onchange="handleUpload(event)">
  <div id="uploadStatus" style="margin-top:6px;color:#555"></div>
</div>


<!-- ===================== WORKLOAD TABLE ===================== -->

<div class="card">
  <h3>Aggregated Workload (Across All Uploaded Employees)</h3>

  <table id="workTable">
    <thead>
      <tr>
        <th>Function</th>
        <th>Employees</th>
        <th>Total Min Hours</th>
        <th>Total Max Hours</th>
        <th>Total Avg Hours</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<!-- ===================== CURRENT HC TABLE ===================== -->

<div class="card">
  <h3>Current Manpower (Auto Extracted from Excel)</h3>

  <table id="hcTable">
    <thead>
      <tr>
        <th>Function</th>
        <th>Manager</th>
        <th>AsstManager</th>
        <th>Officer</th>
        <th>Executive</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<!-- ===================== RUN MODEL ===================== -->

<div class="card">

  <button class="btn primary" onclick="runOptimization()">Run Optimization</button>

  <div id="status" style="margin-top:8px"></div>
</div>


<!-- ===================== RESULTS ===================== -->

<div class="card">
  <h3>Optimization Results</h3>

  <div id="results"></div>
</div>

</div>


<script>

// --------------------------------------------
// GLOBAL STORES
// --------------------------------------------

let EMPLOYEES = [];
let FUNCTIONS = {};
let CURRENT_HC = {};

const ROLES = ["Manager","AsstManager","Officer","Executive"];

const ROLE_MAP = {
  "manager":"Manager",
  "sr manager":"Manager",
  "senior manager":"Manager",

  "assistant manager":"AsstManager",
  "asst manager":"AsstManager",
  "am":"AsstManager",

  "officer":"Officer",

  "executive":"Executive",
  "jr executive":"Executive",
  "junior executive":"Executive"
};


// --------------------------------------------
// FUNCTION DETECTION
// --------------------------------------------

function detectFunction(rows){

  const KEYS = [
    "function","department","business unit","vertical",
    "division","team","sbu","bu","process"
  ];

  let func = "";

  rows.forEach(r=>{
    if(!r[0] || !r[1]) return;

    const k = r[0].toString().toLowerCase();

    for(const key of KEYS){
      if(k.includes(key)){
        func = r[1].toString().trim();
        break;
      }
    }
  });

  if(!func)
    func = prompt("Function not detected — enter Function name:") || "Unknown Function";

  return func;
}


// --------------------------------------------
// ROLE / DESIGNATION DETECTOR
// --------------------------------------------

function detectRole(rows){

  let role = "Executive";

  rows.forEach(r=>{
    if(!r[0] || !r[1]) return;

    const key = r[0].toString().toLowerCase();
    const val = r[1].toString().toLowerCase();

    if(
      key.includes("role") ||
      key.includes("designation") ||
      key.includes("employee grade") ||
      key.includes("position")
    ){
      for(const k in ROLE_MAP){
        if(val.includes(k)){
          role = ROLE_MAP[k];
          break;
        }
      }
    }
  });

  return role;
}


// --------------------------------------------
// ADD EMPLOYEE + AGGREGATE
// --------------------------------------------

function addEmployee(func, role, minH, maxH){

  const avgH = (minH + maxH) / 2;

  EMPLOYEES.push({ func, role, min:minH, max:maxH, avg:avgH });

  // workload aggregation
  if(!FUNCTIONS[func])
    FUNCTIONS[func] = { employees:0, min:0, max:0, avg:0 };

  FUNCTIONS[func].employees++;
  FUNCTIONS[func].min += minH;
  FUNCTIONS[func].max += maxH;
  FUNCTIONS[func].avg += avgH;

  // headcount aggregation
  const key = `${func}|${role}`;
  CURRENT_HC[key] = (CURRENT_HC[key] || 0) + 1;
}


// --------------------------------------------
// RENDER TABLES
// --------------------------------------------

function renderWorkloadTable(){

  let body = "";

  Object.keys(FUNCTIONS).forEach(f=>{
    const d = FUNCTIONS[f];
    body += `
      <tr>
        <td>${f}</td>
        <td>${d.employees}</td>
        <td>${d.min.toFixed(2)}</td>
        <td>${d.max.toFixed(2)}</td>
        <td>${d.avg.toFixed(2)}</td>
      </tr>`;
  });

  document.querySelector("#workTable tbody").innerHTML = body;
}


function renderHCtable(){

  let body = "";

  Object.keys(FUNCTIONS).forEach(f=>{

    body += `<tr><td>${f}</td>`;

    ROLES.forEach(role=>{
      const key = `${f}|${role}`;
      body += `<td>${CURRENT_HC[key] || 0}</td>`;
    });

    body += `</tr>`;
  });

  document.querySelector("#hcTable tbody").innerHTML = body;
}


// --------------------------------------------
// FILE UPLOAD HANDLER (MULTIPLE FILES)
// --------------------------------------------

async function handleUpload(evt){

  const files = evt.target.files;

  for(const file of files){

    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf,{type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet,{header:1});

    const func = detectFunction(rows);
    const role = detectRole(rows);

    // numeric workload values
    const nums = rows.flat().filter(x => !isNaN(x) && x>0 && x<24);

    const maxH = nums.at(-1);
    const minH = nums.length>1 ? nums.at(-2) : maxH;

    addEmployee(func, role, minH, maxH);
  }

  uploadStatus.innerHTML = `${files.length} file(s) processed`;

  renderWorkloadTable();
  renderHCtable();
}


// --------------------------------------------
// RUN OPTIMIZATION
// --------------------------------------------

function runOptimization(){

  document.getElementById("status").innerHTML = "Running optimization…";

  fetch("http://127.0.0.1:8000/optimize",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      N_current: CURRENT_HC
    })
  })
  .then(r=>r.json())
  .then(data=>{

    document.getElementById("status").innerHTML =
      `<span class="green">Optimization Completed ✔</span>`;

    let html = `
    <table>
    <tr>
      <th>Function</th>
      <th>Role</th>
      <th>Current</th>
      <th>Optimal</th>
      <th>Surplus / Removable</th>
      <th>Capacity</th>
      <th>Shortage</th>
    </tr>`;

    data.rows.forEach(r=>{
      html += `
      <tr>
        <td>${r.Function}</td>
        <td>${r.Role}</td>
        <td>${r.Current}</td>
        <td>${r.Optimal}</td>
        <td>${r.Removed}</td>
        <td>${r.Capacity}</td>
        <td>${r.Shortage}</td>
      </tr>`;
    });

    html += "</table>";

    document.getElementById("results").innerHTML = html;
  })
  .catch(()=>{
    document.getElementById("status").innerHTML =
      "<span style='color:#b45309'>Backend not reachable</span>";
  });
}

</script>

</body>
</html>
